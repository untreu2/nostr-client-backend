<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NDK CDN</title>
    <script src="https://unpkg.com/@nostr-dev-kit/ndk@latest"></script>
    <script>
        let ndk;
        let npub;

        function initializeNDK(relays) {
            ndk = new NDK({
                explicitRelayUrls: relays
            });

            ndk.connect().then(() => {
                console.log('Connected to relays:', relays);
                window.ReactNativeWebView.postMessage(JSON.stringify({ type: 'connected', message: 'Connected to relays: ' + relays }));
            }).catch((error) => {
                console.error('Error connecting to relays:', error);
                window.ReactNativeWebView.postMessage(JSON.stringify({ type: 'error', message: 'Error: ' + error }));
            });
        }

        function generateNpub(nsec) {
            npub = ndk.utils.getPublicKey(nsec);
            console.log('Generated npub:', npub);
            window.ReactNativeWebView.postMessage(JSON.stringify({ type: 'npubGenerated', npub: npub }));
        }

        function createAndPublishEvent(content, nsec) {
            const event = new NDKEvent(ndk);
            event.kind = 1;
            event.content = content;

            ndk.utils.signEvent(event, nsec).then(() => {
                event.publish().then(() => {
                    console.log('Event published:', event);
                    window.ReactNativeWebView.postMessage(JSON.stringify({ type: 'eventPublished', eventId: event.id }));
                }).catch((error) => {
                    console.error('Error publishing event:', error);
                    window.ReactNativeWebView.postMessage(JSON.stringify({ type: 'error', message: 'Error: ' + error }));
                });
            });
        }

        function fetchUserProfile(npub) {
            const user = ndk.getUser({ npub: npub });

            user.fetchProfile().then(() => {
                console.log('Fetched profile:', user.profile);
                window.ReactNativeWebView.postMessage(JSON.stringify({ type: 'profileFetched', profile: user.profile }));
            }).catch((error) => {
                console.error('Error fetching profile:', error);
                window.ReactNativeWebView.postMessage(JSON.stringify({ type: 'error', message: 'Error: ' + error }));
            });
        }

        function fetchEvents(authorNpub, kind = 1) {
            const filter = {
                kinds: [kind],
                authors: [authorNpub]
            };

            ndk.fetchEvents(filter).then((events) => {
                console.log('Fetched events:', events);
                window.ReactNativeWebView.postMessage(JSON.stringify({ type: 'eventsFetched', events: events }));
            }).catch((error) => {
                console.error('Error fetching events:', error);
                window.ReactNativeWebView.postMessage(JSON.stringify({ type: 'error', message: 'Error: ' + error }));
            });
        }

        function reactToEvent(eventId, reaction) {
            ndk.fetchEvent({ ids: [eventId] }).then((event) => {
                event.react(reaction).then(() => {
                    console.log('Reacted to event:', eventId, reaction);
                    window.ReactNativeWebView.postMessage(JSON.stringify({ type: 'reactionSuccess', message: 'Reacted to event: ' + eventId }));
                }).catch((error) => {
                    console.error('Error reacting to event:', error);
                    window.ReactNativeWebView.postMessage(JSON.stringify({ type: 'error', message: 'Error: ' + error }));
                });
            });
        }

        function subscribeToEvents(authorNpub, kind = 1) {
            const filter = {
                kinds: [kind],
                authors: [authorNpub]
            };

            ndk.subscribe(filter, { closeOnEose: false }).then((subscription) => {
                console.log('Subscribed to events:', subscription);
                window.ReactNativeWebView.postMessage(JSON.stringify({ type: 'subscriptionSuccess', message: 'Subscribed to events: ' + authorNpub }));
            }).catch((error) => {
                console.error('Error subscribing to events:', error);
                window.ReactNativeWebView.postMessage(JSON.stringify({ type: 'error', message: 'Error: ' + error }));
            });
        }
    </script>
</head>
<body>
    <h1>NDK CDN</h1>
</body>
</html>
